


<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <meta name="description" content="使用链式调用解决多可选参数接口设计问题">
  <meta name="keywords" content="iOS,Objective-C,">
  <title>使用链式调用解决多可选参数接口设计问题 - Eleme Mobilists</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/eleme-theme.css">
    
  
</head>
<body>

<div id="wrapper">
    <div id="eleme-menu-outer">
        <div id="eleme-menu-wrapper">
            <a href="/"><img src="/img/eleme-logo.png"></a>
                <div id="menu-inner">
                
                <a href="/">主页</a>
                
                <a href="/archives">归档</a>
                
                <a href="/about">关于</a>
                
            </div>
        </div>
    </div>

    <div id="eleme-content-outer">
        <div id="content-inner">
            <article id="post">
    <h1 class="post-title">使用链式调用解决多可选参数接口设计问题</h1>
    <p class="post-meta">
        
        <span class="release">发表于
            <time datetime="2017-01-11T14:25:00.000Z">
            2017-01-11
            </time>
        </span>
        
        
        <span>&nbsp;分类: <a href="/categories/iOS/">iOS</a></span>
        
        
        <span class="author">&nbsp;authored by <a target="_blank" href="https://github.com/axl411">axl411</a></span>
        
    </p>
    <div class="post-wrapper">
        <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>我们在 coding 的征途中，总会写下几个（or 几十个?）<code>xxxUtils</code> 之类的东西。想象有这样一个 <code>NVMImageUtils</code>，一开始它的接口是这样的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> &#123;</div><div class="line">  <span class="comment">// IMP</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>马上需要加个参数 borderColor，是可选的，于是接口成了这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> imageWithSize:size color:color borderColor:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> borderColor:(<span class="built_in">UIColor</span> *)borderColor &#123;</div><div class="line">  <span class="comment">// IMP</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>过段时间再加个参数 cornerRadius：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> imageWithSize:size color:color borderColor:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> borderColor:(<span class="built_in">UIColor</span> *)borderColor &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> imageWithSize:size color:color borderColor:borderColor cornerRadius:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> cornerRadius:(<span class="built_in">NSNumber</span> *) cornerRadius &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> imageWithSize:size color:color borderColor:<span class="literal">nil</span> cornerRadius:cornerRadius];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">UIImage</span> *)imageWithSize:(<span class="built_in">CGSize</span>)size color:(<span class="built_in">UIColor</span> *)<span class="built_in">UIColor</span> borderColor:(<span class="built_in">UIColor</span> *)borderColor cornerRadius:(<span class="built_in">NSNumber</span> *)cornerRadius &#123;</div><div class="line">  <span class="comment">// IMP</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要是再加一个 borderWidth，估计就 hold 不住了。。。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>通过玩弄 objc 的语法，最终的效果如下，接口可被链式调用，且需要什么可选参数就调什么：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">UIImage</span> *image = nvm_beginImage(size)</div><div class="line">                     .fillColor(fillColor)     <span class="comment">// optional</span></div><div class="line">                     .borderColor(borderColor) <span class="comment">// optional</span></div><div class="line">                     .cornerRadius(<span class="number">20</span>)         <span class="comment">// optional</span></div><div class="line">                     .opacity(<span class="number">0.5</span>)             <span class="comment">// optional</span></div><div class="line">                     .make;</div></pre></td></tr></table></figure>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>头文件如下，声明一个类叫 <code>NVMImageMaker</code>，用来储存 make 一个 image 需要的各种参数，最终可以通过这些参数 make 出 image：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NVMImageMaker</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">/// image fill color</span></div><div class="line">- (NVMImageMaker* (^)(<span class="built_in">UIColor</span>* imageFillColor))fillColor;</div><div class="line"><span class="comment">/// image border color</span></div><div class="line">- (NVMImageMaker* (^)(<span class="built_in">UIColor</span>* imageBorderColor))borderColor;</div><div class="line"><span class="comment">/// border 的 width, 默认 1 px, 仅当设置了 border color 才有效果</span></div><div class="line">- (NVMImageMaker* (^)(<span class="built_in">CGFloat</span> imageBorderWidth))borderWidth;</div><div class="line"><span class="comment">/// corner radius</span></div><div class="line">- (NVMImageMaker* (^)(<span class="built_in">CGFloat</span> imageCornerRadius))cornerRadius;</div><div class="line"><span class="comment">/// 透明度, 范围 0 - 1, 会应用在整个 image 上</span></div><div class="line">- (NVMImageMaker* (^)(<span class="built_in">CGFloat</span> opacity))opacity;</div><div class="line"></div><div class="line"><span class="comment">/// 生成 image 返回</span></div><div class="line">- (<span class="built_in">UIImage</span> *)make;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init <span class="built_in">NS_UNAVAILABLE</span>;</div><div class="line">+ (<span class="keyword">instancetype</span>)new <span class="built_in">NS_UNAVAILABLE</span>;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">/// API 的入口, 从这里开始进行 chaining 式的 image making</span></div><div class="line"><span class="keyword">extern</span> NVMImageMaker* nvm_beginImage(<span class="built_in">CGSize</span> imageSize);</div></pre></td></tr></table></figure>
<p>接口的入口是 <code>nvm_beginImage()</code>，接收的是必须的参数，这里是 <code>imageSize</code>，用来返回一个 <code>NVMImageMaker</code> 对象，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> NVMImageMaker *_Nonnull nvm_beginImage(<span class="built_in">CGSize</span> imageSize) &#123;</div><div class="line">  NVMImageMaker *maker = [NVMImageMaker new];</div><div class="line">  maker.imageSize = imageSize;</div><div class="line">  <span class="keyword">return</span> maker;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以 <code>fillColor</code> 为例，看一看如何实现链式调用传入可选参数 <code>fillColor</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (NVMImageMaker * (^)(<span class="built_in">UIColor</span> * imageFillColor))fillColor &#123;</div><div class="line">  <span class="keyword">return</span> ^NVMImageMaker *(<span class="built_in">UIColor</span> *imageFillColor) &#123;</div><div class="line">    <span class="keyword">self</span>.imageFillColor = imageFillColor;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里 <code>fillColor</code> 实际返回的是一个 block，这个 block 接收一个真正的 <code>imageFillColor</code>，储存到 self (<code>NVMImageMaker</code>)，然后将 self 返回。配合用 dot 语法调用方法的特性，我们可以做到：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nvm_beginImage(size).fillColor(color)</div><div class="line">|         ①         |   ②   |  ③ |</div><div class="line"><span class="comment">// ①: 返回 NVMImageMaker 实例</span></div><div class="line"><span class="comment">// ②: 返回一个 block，它接收一个 color，然后储存到前面的 NVMImageMaker 实例中，再次将其返回</span></div><div class="line"><span class="comment">// ③: 实际传入 color，再次得到 NVMImageMaker 实例</span></div></pre></td></tr></table></figure>
<p>依此类推，我们可以用这样的思路添加任意的可选参数。</p>
<p>最后，<code>make</code> 方法综合所有得到的参数，绘制成图片返回（实现忽略，不是本篇重点），最终得以通过链式调用得到图片：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nvm_beginImage(size).fillColor(color).make;</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>代码地址：<a href="https://github.com/eleme/NVMImageMaker" target="_blank" rel="external">https://github.com/eleme/NVMImageMaker</a>。可以直接通过 pod 使用，当然实现并不复杂，大可自行实现。</p>
<p>至此，我们有了一个全新的思路，用来解决开篇演示的，让人越来越 hold 不住的多可选参数接口的设计问题。</p>
<hr>
<p>Written by 饿了么iOS组 － <a href="https://github.com/axl411" target="_blank" rel="external">axl411</a></p>

    </div>
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'elememobileblog';
        var disqus_identifier = '2017/01/11/使用链式调用解决多可选参数接口设计问题/';
        var disqus_title = '使用链式调用解决多可选参数接口设计问题';
        var disqus_url = 'http://mobilists.eleme.io/2017/01/11/使用链式调用解决多可选参数接口设计问题/';

        function run_disqus_script(disqus_script){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }

        run_disqus_script('count.js');
        
        run_disqus_script('embed.js');
        
    </script>

    <noscript>Please enable JavaScript to view the comments</noscript>

    
</article>



<nav id="pagination">

 <div class="pagination-indicator">
     

     
     <a href="/2016/09/01/Amigo 源码解读/" class="next-post">Amigo 源码解读 ></a>
     
 </div>
</nav>



        </div>
    </div>

    <div id="eleme-bottom-outer">
        <div id="bottom-inner">
            <p class="eleme-copyright">&copy; copyright 2016-2017 by Eleme Mobilists</p>
            <p class="eleme-theme-copyright">eleme-mobile hexo theme by eleme ios team</a></p>
            <br>
        </div>
    </div>
    
    
    <script src="/js/eleme-theme.js"></script>
    
    
</div>

</body>
</html>
